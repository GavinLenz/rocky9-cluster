---
- name: Ensure Python runtime packages present
  ansible.builtin.package:
    name: "{{ controller_python_system_packages }}"
    state: present
  tags: venv

- name: Verify Python 3 binary exists
  ansible.builtin.stat:
    path: "{{ controller_python_executable }}"
  register: python_bin
  failed_when: not python_bin.stat.exists
  tags: venv

- name: Validate Python version matches {{ controller_python_version }}
  ansible.builtin.command:
    cmd: "{{ controller_python_executable }} --version"
  register: python_version_check
  changed_when: false
  failed_when: >-
    'Python {{ controller_python_version }}' not in (
      (python_version_check.stdout | default('')) ~
      (python_version_check.stderr | default(''))
    )
  tags: venv

- name: Ensure virtual environment directory exists
  ansible.builtin.file:
    path: "{{ controller_venv_path }}"
    state: directory
    mode: '0755'
  tags: venv

- name: Create Python virtual environment (idempotent)
  ansible.builtin.command:
    cmd: "{{ controller_python_executable }} -m venv {{ controller_venv_path }}"
  args:
    creates: "{{ controller_venv_path }}/bin/activate"
  tags: venv

- name: Upgrade pip and core tooling inside venv
  ansible.builtin.pip:
    name: "{{ controller_venv_bootstrap_packages }}"
    state: present
    virtualenv: "{{ controller_venv_path }}"
    virtualenv_command: "{{ controller_python_executable }} -m venv"
  tags: venv

- name: Install controller dependencies inside venv
  ansible.builtin.pip:
    requirements: "{{ controller_requirements_file }}"
    virtualenv: "{{ controller_venv_path }}"
    virtualenv_command: "{{ controller_python_executable }} -m venv"
  tags: venv

- name: Install required Ansible collections
  community.general.ansible_galaxy_install:
    type: collection
    requirements_file: "{{ controller_ansible_collections_requirements }}"
    state: latest
  environment:
    PATH: >-
      {{ controller_venv_bin }}:{{ ansible_env.PATH
      | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}
  tags: venv

- name: Verify Ansible installation inside venv
  ansible.builtin.command:
    cmd: "{{ controller_venv_ansible }} --version"
  register: ansible_check
  changed_when: false
  failed_when: "'[core {{ controller_ansible_core_expected_version }}]' not in ansible_check.stdout"
  tags: venv

- name: Print venv activation hint
  ansible.builtin.debug:
    msg: |
      Virtualenv ready:
        source {{ controller_venv_path }}/bin/activate
  tags: venv
