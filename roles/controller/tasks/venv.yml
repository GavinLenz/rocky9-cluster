---
- name: Ensure Python 3.9 installed
  ansible.builtin.package:
    name:
      - python3
      - python3-devel
    state: present
  tags: venv

- name: Verify Python 3 binary exists
  ansible.builtin.stat:
    path: /usr/bin/python3
  register: python_bin
  failed_when: not python_bin.stat.exists
  tags: venv

- name: Ensure virtual environment directory exists
  ansible.builtin.file:
    path: "{{ cluster_repo_root }}/.venv"
    state: directory
    mode: '0755'
  tags: venv

- name: Create Python virtual environment (idempotent)
  ansible.builtin.command:
    cmd: "{{ python_executable }} -m venv {{ cluster_repo_root }}/.venv"
  args:
    creates: "{{ cluster_repo_root }}/.venv/bin/activate"
  tags: venv

- name: Upgrade pip and core tooling inside venv
  ansible.builtin.pip: # todo: figure out how to import dyanamic list so I dont need to hard code
    name:
      - pip==24.0
      - setuptools==69.0.3
      - wheel==0.42.0
    state: present # todo: 'latest' throws an error so this is current solution
    virtualenv: "{{ venv_path }}"
    virtualenv_command: "{{ python_executable }} -m venv"
  tags: venv

- name: Install cluster dependencies inside venv
  ansible.builtin.pip:
    name: "{{ venv_packages + [ansible_core_package] }}"
    virtualenv: "{{ venv_path }}"
    virtualenv_command: "{{ python_executable }} -m venv"
  tags: venv

- name: Install required Ansible collections
  ansible.builtin.command:
    cmd: >-
      "{{ cluster_repo_root }}/.venv/bin/ansible-galaxy collection install
      {{ ansible_collections | join(' ') }}"
  args:
    chdir: "{{ cluster_repo_root }}"
  changed_when: false
  tags: venv

- name: Verify Ansible installation inside venv
  ansible.builtin.command:
    cmd: "{{ cluster_repo_root }}/.venv/bin/ansible --version"
  register: ansible_check
  changed_when: false
  tags: venv

- name: Print venv activation hint
  ansible.builtin.debug:
    msg: |
      Virtualenv ready:
        source {{ cluster_repo_root }}/.venv/bin/activate
  tags: venv
