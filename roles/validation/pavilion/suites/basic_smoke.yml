---
network_gateway_ping:
  summary: "Controller can reach the configured gateway"
  scheduler: raw
  run:
    cmds:
      - |
        set -eu
        ping -c 4 {{ network_config.gateway | default(network_config.server_ip, true) }}
  result_parse:
    regex:
      regex: '(\d+) packets transmitted, (\d+) received'
      matches: one
  result_evaluate:
    ok:
      formula: "int(result.regex._2) >= 1"
      result: "PASS"
      fail_result: "FAIL"

pxe_tree_check:
  summary: "PXE ISO tree is mounted under /var/www/html/os"
  scheduler: raw
  run:
    cmds:
      - |
        set -eu
        if [[ -f /var/www/html/os/BaseOS/repodata/repomd.xml ]]; then
          echo "PXE_TREE=present"
        else
          echo "PXE_TREE=missing"
          exit 1
        fi
  result_parse:
    regex:
      regex: '^PXE_TREE=(?P<state>\w+)$'
      matches: one
  result_evaluate:
    ok:
      formula: "result.regex.state == 'present'"
      result: "PASS"
      fail_result: "FAIL"

pxe_http_probe:
  summary: "PXE content is served over HTTP"
  scheduler: raw
  run:
    cmds:
      - |
        set -eu
        curl -sfI "http://{{ network_config.server_ip }}/os/" >/dev/null
        echo "PXE_HTTP=ok"
  result_parse:
    regex:
      regex: '^PXE_HTTP=(?P<state>\w+)$'
      matches: one
  result_evaluate:
    ok:
      formula: "result.regex.state == 'ok'"
      result: "PASS"
      fail_result: "FAIL"
