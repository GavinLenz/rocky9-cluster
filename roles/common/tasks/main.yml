---
# roles/common/tasks/main.yml

# 0. Create required groups FIRST
- name: Ensure cluster groups exist
  ansible.builtin.group:
    name: "{{ item.name }}"
    state: present
    system: "{{ item.system | default(true) }}"
  loop: "{{ common_groups }}"
  tags:
    - common
    - users

# 1. Create cluster users
- name: Create cluster users
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ item.groups | default([]) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
  loop: "{{ common_users }}"
  tags:
    - common
    - users

# 2. Allow passwordless sudo for automation user
- name: Allow passwordless sudo for automation user
  ansible.builtin.copy:
    dest: /etc/sudoers.d/99-ansible-nopasswd
    content: "ansible ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: '0440'
  tags:
    - common
    - sudo

# 3. Install authorized SSH keys (NOW VALID)
- name: Install authorized SSH keys
  ansible.posix.authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.authorized_key }}"
    state: present
  loop: "{{ common_users | selectattr('authorized_key','defined') }}"
  when: item.authorized_key | length > 0
  tags:
    - common
    - users

# 4. Deploy internal repo file
- name: Deploy internal cluster repo configuration
  ansible.builtin.template:
    src: local.repo.j2
    dest: /etc/yum.repos.d/cluster.repo
    owner: root
    group: root
    mode: '0644'
  vars:
    controller_ip: "{{ hostvars[groups['controller'][0]].ip | default(hostvars[groups['controller'][0]].ansible_host) }}"
  tags:
    - repo

# 5. Rebuild yum metadata
- name: Clean DNF metadata
  ansible.builtin.command: dnf clean all
  changed_when: false
  tags:
    - repo

- name: Rebuild DNF metadata cache
  ansible.builtin.command: dnf makecache
  changed_when: false
  tags:
    - repo

# 6. Install baseline packages
- name: Ensure baseline packages installed
  ansible.builtin.package:
    name: "{{ common_packages }}"
    state: present
  tags:
    - common
    - bootstrap

# 7. Apply sysctl settings
- name: Apply sysctl defaults
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ common_sysctl | dict2items }}"
  tags:
    - common
    - sysctl

# 8. Apply PAM limits
- name: Apply ulimit settings
  community.general.pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop: "{{ common_limits }}"
  tags:
    - common
    - limits
