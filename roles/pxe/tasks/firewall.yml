---
# 0. Ensure firewalld is installed and running
# handling here instead of preflight.yml to isolate firewall logic
- name: Ensure firewalld is installed
  ansible.builtin.package:
    name: firewalld
    state: present

- name: Ensure firewalld is enabled and running
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: yes

- name: Determine firewall guard requirements
  ansible.builtin.set_fact:
    firewall_target_host: "{{ ansible_host | default(inventory_hostname) }}"
    firewall_needs_ssh_guard: "{{ ((ansible_connection | default('ssh')) != 'local') | bool }}"

# 1. Detect SSH client IP and create a temporary allow rule
- name: Determine SSH source for guard
  ansible.builtin.set_fact:
    ssh_source_ip: >-
      {{ (ansible_env.SSH_CLIENT.split()[0]
          if (ansible_env.SSH_CLIENT | default('')) | length > 0
          else ansible_host | default(inventory_hostname)) | default('') }}
  when: firewall_needs_ssh_guard | bool

- name: Add temporary ACCEPT for current SSH source (runtime only)
  ansible.posix.firewalld:
    source: "{{ ssh_source_ip }}/32"
    state: enabled
    zone: public
    immediate: yes
    permanent: no
  when:
    - firewall_needs_ssh_guard | bool
    - ssh_source_ip | default('') | length > 0

- name: Validate SSH connectivity before applying firewall changes (pre-change)
  ansible.builtin.wait_for:
    host: "{{ firewall_target_host }}"
    port: 22
    timeout: 2
  when:
    - firewall_needs_ssh_guard | bool
    - ssh_source_ip | default('') | length > 0

# 2. Baseline firewall configuration
- name: Allow SSH service permanently
  ansible.posix.firewalld:
    service: ssh
    state: enabled
    zone: public
    permanent: yes

# Allow inbound subnets defined in defaults
# (see pxe_firewall_allowed_subnets in defaults/main.yml)
- name: Allow cluster internal networks
  ansible.posix.firewalld:
    source: "{{ item }}"
    state: enabled
    zone: public
    permanent: yes
  loop: "{{ pxe_settings.firewall_allowed_subnets }}"

- name: Allow PXE + provisioning services on controller
  ansible.posix.firewalld:
    service: "{{ item }}"
    state: enabled
    zone: public
    permanent: yes
  loop:
    - http
    - tftp
    - dhcp
  when: inventory_hostname in groups['controller']

# 4. Commit firewall changes safely
- name: Reload firewalld to commit permanent changes
  ansible.builtin.service:
    name: firewalld
    state: reloaded
  changed_when: false

# 5. Validate SSH connectivity *after* applying new rules
- name: Validate SSH connectivity (post-change)
  ansible.builtin.wait_for:
    host: "{{ firewall_target_host }}"
    port: 22
    timeout: 2
  when:
    - firewall_needs_ssh_guard | bool
    - ssh_source_ip | default('') | length > 0

# 6. Remove temporary SSH allow (runtime only)
- name: Remove temporary SSH allow rule
  ansible.posix.firewalld:
    source: "{{ ssh_source_ip }}/32"
    state: disabled
    zone: public
    immediate: yes
    permanent: no
  when:
    - firewall_needs_ssh_guard | bool
    - ssh_source_ip | default('') | length > 0
