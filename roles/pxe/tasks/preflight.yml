---
- name: Install PXE server packages
  ansible.builtin.package:
    name:
      - dnsmasq
      - tftp-server
      - ipxe-bootimgs
      - httpd
      - python3-libselinux
      - policycoreutils-python-utils
    state: present

- name: Ensure PXE credential hashes are provided
  ansible.builtin.assert:
    that:
      - pxe_settings.root_password_hash is defined
      - pxe_settings.root_password_hash | length > 0
      - pxe_settings.local_user_password_hash is defined
      - pxe_settings.local_user_password_hash | length > 0
    fail_msg: >-
      PXE credential hashes missing.
      Populate PXE_ROOT_PASSWORD_HASH and PXE_LOCAL_USER_PASSWORD_HASH.

- name: Ensure TFTP directory exists
  ansible.builtin.file:
    path: "{{ pxe_settings.tftp_root }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Label TFTP directory for SELinux
  community.general.sefcontext:
    target: "{{ pxe_settings.tftp_root }}(/.*)?"
    setype: tftpdir_t
    state: present
  when:
    - ansible_selinux is defined
    - ansible_selinux.status == "enabled"

- name: Restore SELinux context on TFTP directory
  ansible.builtin.command: restorecon -Fr {{ pxe_settings.tftp_root }}
  changed_when: false
  when:
    - ansible_selinux is defined
    - ansible_selinux.status == "enabled"

- name: Ensure ISO directory exists
  ansible.builtin.file:
    path: "{{ pxe_settings.iso_dir }}"
    state: directory
    mode: "0755"

- name: Ensure ISO mount directory exists
  ansible.builtin.file:
    path: "{{ pxe_settings.iso_mount }}"
    state: directory
    mode: "0755"

- name: Check PXE interface exists
  ansible.builtin.stat:
    path: "/sys/class/net/{{ pxe_settings.boot_interface }}"
  register: pxe_iface_stat
  when:
    - pxe_settings.boot_interface is defined
    - pxe_settings.boot_interface | length > 0

- name: Assert PXE interface is present
  ansible.builtin.assert:
    that:
      - pxe_iface_stat.stat.exists | default(false)
    fail_msg: >-
      PXE interface {{ pxe_settings.boot_interface }} missing. Update network_config.pxe_iface
      in config/net.yml to a valid interface name on this host.
  when:
    - pxe_iface_stat is defined

- name: Bring PXE interface up (best effort)
  ansible.builtin.command: ip link set dev {{ pxe_settings.boot_interface }} up
  changed_when: false
  failed_when: false
  when:
    - pxe_iface_stat is defined
    - pxe_iface_stat.stat.exists | default(false)

- name: Assert PXE server IP is configured locally
  ansible.builtin.assert:
    that:
      - pxe_settings.server_ip in ansible_all_ipv4_addresses
    fail_msg: >-
      PXE server_ip {{ pxe_settings.server_ip }} is not assigned on this host. Ensure
      network_config.server_ip in config/net.yml matches an address on this
      machine (and that the interface is up) before starting dnsmasq.

- name: Deploy neutral /etc/dnsmasq.conf
  ansible.builtin.copy:
    dest: /etc/dnsmasq.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      # Managed by Ansible PXE role
      user=dnsmasq
      group=dnsmasq
      conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig
  notify: restart dnsmasq

- name: Ensure Apache root directory exists
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: root
    group: root
    mode: "0755"
