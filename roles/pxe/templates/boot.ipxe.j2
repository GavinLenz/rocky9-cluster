#!ipxe
# 1. Let the user see whatâ€™s happening
echo Booting cluster image in 5 s ...
echo MAC: ${mac:hexhyp}  IP: ${ip}
echo Press ^C to abort, or 's' for shell ...

# 2. Countdown (5000 ms) that accepts keypress
prompt --timeout 5000 --key s shell && shell || goto boot_cluster

# 3. Select default target (fresh install vs. local disk)
:boot_cluster
set default_target {{ pxe_default_target | default('fresh') | lower }}
iseq ${default_target} local && goto boot_local ||
iseq ${default_target} fresh && goto boot_fresh || goto boot_fresh

:boot_fresh
# 4. HTTP installer with explicit stage2/repo/ks
kernel http://{{ pxe_settings.server_ip }}/os/images/pxeboot/vmlinuz initrd=initrd.img inst.repo=http://{{ pxe_settings.server_ip }}/os inst.ks=http://{{ pxe_settings.server_ip }}/ks.cfg ip=dhcp rd.neednet=1 inst.text
initrd http://{{ pxe_settings.server_ip }}/os/images/pxeboot/initrd.img
boot

:boot_local
# 5. Safety net: boot from NVMe
sanboot --no-describe --drive 0x80
