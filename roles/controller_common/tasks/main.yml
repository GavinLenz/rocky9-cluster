---
# roles/controller_common/tasks/main.yml

# 0. Create required groups FIRST
- name: Ensure cluster groups exist
  ansible.builtin.group:
    name: "{{ item.name }}"
    state: present
    system: "{{ item.system | default(true) }}"
  loop: "{{ common_groups }}"

# 1. Create cluster users
- name: Create cluster users
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ item.groups | default([]) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
  loop: "{{ common_users }}"

# 2. Allow passwordless sudo for automation user
- name: Allow passwordless sudo for automation user
  ansible.builtin.copy:
    dest: /etc/sudoers.d/99-ansible-nopasswd
    content: "ansible ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: '0440'

# 3. Install authorized SSH keys
- name: Install authorized SSH keys
  ansible.posix.authorized_key:
    user: "{{ item.name }}"
    key: "{{ item.authorized_key }}"
    state: present
  loop: "{{ common_users | selectattr('authorized_key','defined') }}"
  when: item.authorized_key | length > 0

# 4. Ensure core Rocky repos enabled
- name: Discover defined DNF repositories
  ansible.builtin.command:
    argv:
      - grep
      - -Rho
      - '^\[.*\]'
      - /etc/yum.repos.d
  register: controller_repo_scan
  changed_when: false
  failed_when: controller_repo_scan.rc not in [0, 1]

- name: Cache controller repo IDs
  ansible.builtin.set_fact:
    controller_available_repo_ids: >-
      {{ controller_repo_scan.stdout_lines | default([])
         | map('regex_replace', '^\\[(.+)\\]$', '\\1')
         | list | unique }}

- name: Determine required repo IDs per distribution
  ansible.builtin.set_fact:
    controller_core_repo_ids_effective: >-
      {{ controller_core_repo_ids if controller_core_repo_ids | length > 0 else
         (controller_core_repo_map[controller_repo_distribution_key]
          | default(controller_core_repo_map[controller_core_repo_default_distribution])) }}
  vars:
    controller_repo_distribution_key: "{{ ansible_distribution | default(controller_core_repo_default_distribution) | lower }}"

- name: Validate required repo definitions exist
  ansible.builtin.fail:
    msg: >-
      Unable to locate repo id(s) {{ missing_repos | join(', ') }} under /etc/yum.repos.d.
      Update controller_core_repo_ids with the IDs present on this host before rerunning.
  when: missing_repos | length > 0
  vars:
    missing_repos: "{{ controller_core_repo_ids_effective | difference(controller_available_repo_ids | default([])) }}"

- name: Ensure required repos enabled
  ansible.builtin.command:
    cmd: "dnf config-manager --set-enabled {{ item }}"
  loop: "{{ controller_core_repo_ids_effective }}"
  loop_control:
    label: "{{ item }}"
  changed_when: false

# 5. Install baseline packages
- name: Ensure baseline packages installed
  ansible.builtin.package:
    name: "{{ common_packages }}"
    state: present

# 6. Apply sysctl settings
- name: Apply sysctl defaults
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ common_sysctl | dict2items }}"

# 7. Apply PAM limits
- name: Apply ulimit settings
  community.general.pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop: "{{ common_limits }}"
